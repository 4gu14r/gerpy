name: Release Automática

on:
  workflow_run:
    workflows: ["Changelog"]
    types:
      - completed

permissions:
  contents: write

jobs:
  release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Baixa a tag (tag.txt) re‑enviada pelo Changelog
      - name: Baixar tag da execução de Changelog
        uses: actions/download-artifact@v4
        with:
          name: release-tag
          path: .

      - name: Ler a tag
        id: read_tag
        run: |
          TAG=$(cat tag.txt)
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      # 2️⃣ Instalar gh para buscar o artefato do build
      - name: Instalar GitHub CLI
        run: |
          sudo apt update && sudo apt install -y gh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 3️⃣ Encontrar o run mais recente do Build EXE on Windows
      - name: Encontrar run do Build EXE
        id: build_run
        run: |
          RUN_ID=$(gh run list \
            --workflow="Build EXE on Windows" \
            --branch=master --limit=1 \
            --json databaseId,status \
            -q '.[] | select(.status=="completed") | .databaseId')
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 4️⃣ Baixar o artefato app‑windows desse run
      - name: Baixar artefato .exe
        run: |
          mkdir -p artifact
          gh run download ${{ steps.build_run.outputs.run_id }} \
            -n app-windows -D artifact
          ls artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 5️⃣ Criar o Release no GitHub com a tag e o exe
      - name: Criar Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.read_tag.outputs.tag }}
          name: "Release ${{ steps.read_tag.outputs.tag }}"
          files: artifact/main.exe
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
