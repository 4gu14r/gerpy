name: Release Automática

on:
  workflow_run:
    workflows: ["Changelog"]
    types:
      - completed

permissions:
  contents: write

jobs:
  release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Baixar artefato release-tag
        uses: actions/download-artifact@v4
        with:
          name: release-tag
          path: .

      - name: Ler tag da release
        id: tag
        run: |
          TAG=$(cat tag.txt)
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Verificar se a tag é nova
        id: check_tag
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 ${{ steps.tag.outputs.tag }}^ 2>/dev/null || echo "")
          if [ "${{ steps.tag.outputs.tag }}" != "$LAST_TAG" ]; then
            echo "A tag ${{ steps.tag.outputs.tag }} é nova."
            echo "new_tag=true" >> $GITHUB_OUTPUT
          else
            echo "A tag ${{ steps.tag.outputs.tag }} não é nova."
            echo "new_tag=false" >> $GITHUB_OUTPUT
          fi

      - name: Baixar artefato app-windows
        if: steps.check_tag.outputs.new_tag == 'true'
        uses: actions/download-artifact@v4
        with:
          name: app-windows
          path: artifact

      - name: Criar release com o .exe
        if: steps.check_tag.outputs.new_tag == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "Release ${{ steps.tag.outputs.tag }}"
          files: artifact/main.exe
          generate_release_notes: true