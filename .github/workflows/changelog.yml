name: Changelog

on:
  workflow_run:
    workflows: ["Criar Tag"] 
    types:
      - completed


permissions:
  contents: write

jobs:
  changelog:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout completo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Buscar todas as tags
        run: |
          git fetch --tags --force


      - name: Instalar GitHub CLI
        run: |
          sudo apt update
          sudo apt install gh -y

      - name: Baixar tag da execução anterior
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Obtem o run-id da última execução bem-sucedida do workflow "Criar Tag"
          RUN_ID=$(gh run list --workflow="Criar Tag" --branch=master --limit=1 --json databaseId -q '.[0].databaseId')

          echo "Último run-id do workflow 'Criar Tag': $RUN_ID"

          # Baixa o artefato release-tag
          gh run download $RUN_ID -n release-tag

      - name: Ler tag da release
        id: tag
        run: |
          TAG=$(cat tag.txt)
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Debug da tag lida
        run: |
          cat tag.txt
          echo "Tag recebida: ${{ steps.tag.outputs.tag }}"

      - name: Gerar changelog
        run: |
          NEW_TAG="${{ steps.tag.outputs.tag }}"
          LAST_TAG=$(git describe --tags --abbrev=0 ${NEW_TAG}^ 2>/dev/null || echo "")

          echo "Última tag: $LAST_TAG"
          echo "Nova tag: $NEW_TAG"

          echo "## $NEW_TAG - $(date +'%Y-%m-%d')" > temp_changelog.md

          if [ -z "$LAST_TAG" ]; then
            git log --pretty=format:"- %s" >> temp_changelog.md
          else
            git log $LAST_TAG..$NEW_TAG --pretty=format:"- %s" >> temp_changelog.md
          fi

          echo "" >> temp_changelog.md

          if [ -f CHANGELOG.md ]; then
            sed "/^## $NEW_TAG - /,/^## /{/^## $NEW_TAG - /!{/^## /!d}}" CHANGELOG.md >> temp_changelog.md
          fi

          touch CHANGELOG.md

          mv temp_changelog.md CHANGELOG.md
          cat CHANGELOG.md

      - name: Commitar e pushar changelog
        run: |
          touch CHANGELOG.md
          
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          git checkout ${{ github.event.workflow_run.head_branch }}

          git add CHANGELOG.md
          git commit -m "docs(changelog): atualizar changelog automático [skip ci]" || echo "Nada para commitar"
          git push origin ${{ github.event.workflow_run.head_branch }}
