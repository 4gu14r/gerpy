name: Changelog

# on:
#   workflow_run:
#     workflows: ["Criar Tag"]   # o nome do seu workflow tags.yml
#     types:
#       - completed

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  changelog:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout completo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configurar Git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

      - name: Gerar changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^)
          NEW_TAG=$(git describe --tags --abbrev=0)
          echo "Última tag: $LAST_TAG"
          echo "Nova tag: $NEW_TAG"

          echo "## $NEW_TAG - $(date +'%Y-%m-%d')" > temp_changelog.md
          git log $LAST_TAG..$NEW_TAG --pretty=format:"- %s" >> temp_changelog.md
          echo "" >> temp_changelog.md

          if [ -f CHANGELOG.md ]; then
            cat CHANGELOG.md >> temp_changelog.md
          fi

          mv temp_changelog.md CHANGELOG.md
          cat CHANGELOG.md

      - name: Commitar e pushar changelog
        run: |
          git add CHANGELOG.md
          git commit -m "docs(changelog): atualizar changelog automático [skip ci]" || echo "Nada para commitar"
          git push origin HEAD
